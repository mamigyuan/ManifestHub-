name: Sync Branches from Upstream

on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    - cron: '0 */6 * * *'  # 每 6 小时自动同步一次

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取所有历史
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add upstream remote
        run: git remote add upstream https://github.com/SteamAutoCracks/ManifestHub.git

      - name: Fetch upstream
        run: git fetch upstream

      - name: Sync all branches
        run: |
          # 同步所有现有分支的更新
          git -c core.quotepath=false ls-remote --heads upstream | while read -r hash branch; do
            # 提取分支名（去掉refs/heads/前缀）
            branch_name="${branch#refs/heads/}"
            echo "正在同步分支: $branch_name"
            
            if git show-ref --verify --quiet "refs/heads/$branch_name"; then
              # 如果本地分支已存在，拉取更新并推送
              git checkout "$branch_name"
              git pull upstream "$branch_name"
              git push origin "$branch_name"
            else
              # 如果本地分支不存在，从上游创建并推送
              git checkout -b "$branch_name" "upstream/$branch_name"
              git push origin "$branch_name"
            fi
          done
